<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
<style>

li{list-style:none;}
ul {margin: 0 0 20px 0; padding: 0; }
#stage-state {width: 100%; position: fixed; top: 0; left: 0; z-index: 30; display: flex; gap: 10px; height: 40px; align-items: center; justify-content: center; background-color: #fff;}
#skin-mbti {width: 80%; max-width: 1200px; margin: 0 auto;}
#skin-mbti h2 {text-align: center; color: #007bff; font-size: 26px;}
#skin-mbti .section-box ul li {margin-bottom: 5px; position: relative; text-align: center;}
#skin-mbti .section-box ul li strong {font-size: 22px; margin-bottom: 25px; display: block;}
#skin-mbti .section-box ul li label{margin: 0 auto; display: block;background-color: #efefef; width: 300px; height: 36px;text-align: center; border-radius: 15px; line-height: 36px;}
#skin-mbti .section-box ul li input {position: absolute; }
#skin-mbti .section-box ul li input:checked + label{ background-color: #007bff; color: #fff; font-weight: 600;}
#skin-mbti .section-box .submit {border: 1px solid #696969; display: block; width: 300px; height: 33px; border-radius: 15px; margin: 0 auto;}
.section_name_A__list input:radio:checked {background-color: yellow;}
.done {height: 0px; overflow: hidden;}
</style>  


<br>
<br>
<hr>
<ul id="stage-state"></ul>
<div id="skin-mbti"></div>

<br>
<br>
<button class="next">next</button>
<button class="del">delcookie</button>
<button class="get">getcookie</button>


  <script src="./data.js"></script>
  <script>
  //값이있는지 확인 // 쿠키와비교 // init 함수 만들기 
  //검사 완료 쿠키 - 검사도중 쿠키 날리고 결과 쿠키만 일정시간남김 - 메인 갈때 쿠키있으면 (결과확인, 다시 테스트 링크)
  //검사도중 쿠키 -  체크박스 클릭때마다 쿠키 덮어쓰면서 문항저장함 // 기간은 1-2시간정도 남기기 (진행중인 검사 , 다시 테스트 링크)
  // 결과 페이지 - 마지막 값을 get 데이터로 넘겨서 파라미터로 받은값에따라서 결과 내용 출력하기 
  // 링크도 동일하게 링크를 객체에 담던지 , 링크경로를 포멧팅하던지 하기
  //각 섹션에 점수 기준 객체 만들기;
  //쿠키로 보내고 ; 렌더링할때 쿠키 확인
  console.log(QUESTION_DATA)


  /*---------------------------------------쿠키----------------------------------------------*/
  //쿠키 생성
  const setCookie = (name,value,m) => {
    var date = new Date();
    date.setTime(date.getTime() + m * 60 * 1000);
    document.cookie = name + "=" + encodeURI(value) +  ';expires=' + date.toUTCString() + ';path=/';
  }

  //쿠키 삭제
  const delCookie = (Name) => {
    var expireDate = new Date();
    expireDate.setDate(expireDate.getDate() - 1);
    document.cookie = Name + "= " + "; expires=" + expireDate.toGMTString() + "; path=/";
  }

  //쿠키 가져오기
  const getCookie = (name) => {
    var x, y;
    var val = document.cookie.split(';');
    for (var i = 0; i < val.length; i++) {
        x = val[i].substr(0, val[i].indexOf('='));
        y = val[i].substr(val[i].indexOf('=') + 1);
        x = x.replace(/^\s+|\s+$/g, '');
        if (x == name) {
            return unescape(y);
        }
    }
  }

  /*-------------------------------------요소 생성----------------------------------------------*/

//진행 스테이지 표시창 생성
  const createStageBar = (stageBox,data) => {
    var html = "";

    data.forEach(({section_id , section_name}) => {
      html += `<li data-id=${section_id} >${section_name}</li>`
    })
    stageBox.insertAdjacentHTML('beforeend',html);

    return {
      update : (id = "OD") => {
        console.log(id)
        var currntStageIdx = data.findIndex(({section_id})=> section_id === id);
        var stages = [...stageBox.children];

        stages.forEach(li => li.style.background = "#fff")
        stages.forEach((li,i) => {
          if (i <= currntStageIdx - 1) {
            li.style.background = "#007bff";
          }
        })
      }
    }
  }
  var stageBar = createStageBar(document.querySelector('#stage-state'),QUESTION_DATA)

  //폼 요소 생성 
  const createForm = ({section_id, section_name, data}, wrap) => {
    var html = "";
    html += `<h2 class="stage-title" data-id=${section_id}>${section_name}</h2>`;
    html += `<section id=${section_id + "section"} class="section-box">`;

    data.forEach(({id, question, option}) => {
        html += `<ul class=${section_name + "__" + "list"}>`;
        html += `<li><strong>${id+"."+question}</strong></li>`;

        option.forEach(({no, option_text}) => {
          html += "<li>";
          html += `<input id=${section_id+id+no} type="radio" value="${no}" name="${section_id+id}" hidden/>`;
          html += `<label for=${section_id+id+no}>${option_text}</label>`;
          //html += "";
          html += "</li>";
        })
        html += "</ul>";
    })
    html += `<button class='submit' data-id=${section_id}>submit</button>`
    html += "</section>";
    wrap.insertAdjacentHTML('beforeend',html);

    return document.getElementById(section_id + "section");
  }
  const mbtiWrap = document.getElementById('skin-mbti');
  //const form = createForm(QUESTION_DATA[0],mbtiWrap)


/*---------------------------------------기능함수-----------------------------------------*/

//쿠키 데이터 담아서 보내기 
  const sendParamsToCookie = () => {
    var isHistory = getCookie(COOKIE_OPTION.history.name) 
    var params = isHistory ?  new URLSearchParams(isHistory) : new URLSearchParams() 

    return (key , value) => {
      if(!key || !value) return

      params.set(key,value)
      params.sort();
      setCookie(COOKIE_OPTION.history.name ,params.toString(), COOKIE_OPTION.history.time)
    }
  }
  let sendParams = sendParamsToCookie()


  //상품 전체 체크 확인 
  const checkPass = ({section_id ,data}) => {
    var mapRadio = data.map(obj => [...document.getElementsByName(section_id + obj.id)])
    var checkSelect = mapRadio.every(radioArr => radioArr.find(radio => radio.checked === true));
    return checkSelect
  }

  //진행중 쿠키에 기록된 내용 체크
  const recoveryChecked = (cookieData) => {
    var params = new URLSearchParams(cookieData);

      for (const [key, value] of params.entries()) {
        var inputs = [...document.getElementsByName(key)]
        var checkTarget = inputs.find(input => input.value === value)
        checkTarget.checked = true
      }
  }

  //점수 계산
  const calcScore = ({section_id ,data}) =>{
  var mapRadio = data.map(obj => [...document.getElementsByName(section_id + obj.id)])
  var score = 0;

  var filterRadio = mapRadio.flat(1).filter(radio => radio.checked === true)
  score += filterRadio.reduce((acc,curr) => acc + QUESTION_SCORE[curr.value],0)
  console.log("타입 :",QUESTION_TYPE[section_id](score),"--","점수 :",score)//result 

  return score
  }

  //요소로 스크롤
  const scrollIntoSection = (id) => {
    var el = document.getElementById(id + "section")
    el.scrollIntoView({ behavior: "smooth", block: "start", inline: "center" });
  }


/*----------------------------------분기처리-------------------------------------------------*/
//로드될때 체크 여부 분기 
const loadBranch = () => {
  var getHistory = getCookie(COOKIE_OPTION.history.name);

  if (getHistory) {
    var score = new URLSearchParams(getHistory);

    for (const [key] of score.entries()) {
      QUESTION_PROGRESS_STATE[key.replace(/[0-9]/ig,"")] = true;
    }

    var lastSection;
    QUESTION_DATA.forEach((data , i) => {
      if(QUESTION_PROGRESS_STATE[data.section_id]){
        var form = createForm(data,mbtiWrap);
        form.classList.add("done")
        lastSection = form
        data.section_id + "section"
        stageBar.update(data.section_id)
      }
    })
    
    lastSection.classList.remove("done")
    recoveryChecked(getHistory)
    console.log("load save")
  }
  else {
    createForm(QUESTION_DATA[0],mbtiWrap)
    console.log("new")
  }
}
loadBranch()


//제목버튼 분기
const btnBranch = (e) => {
    if (e.target.className !== "stage-title")  return

    var boxes = document.querySelectorAll('.section-box')

    if (boxes.length > 1) {
      boxes.forEach(box => {
        if (box.id.includes(e.target.dataset.id + "section")) {
          stageBar.update(e.target.dataset.id)
          box.classList.remove('done')
        }
        else{
          box.classList.add('done')
        }
      })
    }
}

//스테이지 완료 버튼 누를때 분기
const submitBranch = (e) => {
  if(e.target.tagName !== "BUTTON") return
  var submitId = e.target.dataset.id;
  var finish = false;

  QUESTION_DATA.forEach((data,i,arr) => {
    if(submitId === data.section_id && checkPass(data)){
      //전부 체크
      var section = document.getElementById(data.section_id + "section")
      var nextSection = document.getElementById(arr[i + 1]?.section_id + "section")
      section.classList.add("done")
      

      if (i < arr.length - 1 && !nextSection) {
        var newSection = createForm(arr[i+1],mbtiWrap);
        console.log(arr[i+1].section_id)
        scrollIntoSection(arr[i+1].section_id)
        stageBar.update(arr[i+1].section_id)
      } 
      else if(nextSection){
          nextSection.classList.remove('done')
          stageBar.update(arr[i + 1].section_id)
      }

      if (i === arr.length - 1) {
        finish = true //끝
        return
      }

    } 
    else if(submitId === data.section_id && !checkPass(data)){
      console.log("error")
    }

  })

  if(finish){         //점수랑 등급 쿼리스트링에 붙여서 보내고, 쿠키로도 저장하기 
      var type = "";
      var score = new URLSearchParams();
      QUESTION_DATA.forEach(data =>{
        type += QUESTION_TYPE[data.section_id](calcScore(data)) //임시
        score.set(data.section_id,calcScore(data));
      })
        
        delCookie(COOKIE_OPTION.history.name)
        setCookie(COOKIE_OPTION.result.name, type, COOKIE_OPTION.result.time)
        location.href = `/result.html?type=${type}&score=${score.toString()}`;
  }
} //submitBranch


/*--------------------------------------이벤트-------------------------------------------------*/
  mbtiWrap.addEventListener('change', e => {
      if(e.target.type !== "radio") return 
      sendParams(e.target.name,e.target.value)  
  })

  mbtiWrap.addEventListener('click', e => {
    btnBranch(e)
    submitBranch(e)
  })


  //test 
document.querySelector('.del').addEventListener('click',()=>{delCookie('skintype')})
document.querySelector('.get').addEventListener('click',()=>{console.log(getCookie('skintype'))})

  </script>
</body>
</html>