<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
<style>
html {scroll-behavior: smooth } 
li{list-style:none;}
ul {margin: 0 0 20px 0; padding: 0; }
#stage-state {width: 100%; position: fixed; top: 0; left: 0; z-index: 30; display: flex; gap: 10px; height: 40px; align-items: center; justify-content: center; background-color: #fff;}
#skin-mbti {width: 80%; max-width: 1200px; margin: 0 auto;}
#skin-mbti .question-box ul{border: #333 1px solid; padding: 25px 15px ; opacity: 0.3;}
#skin-mbti h2 {text-align: center; color: #007bff; font-size: 26px;}
#skin-mbti .question-box ul li {margin-bottom: 5px; position: relative; text-align: left; }
#skin-mbti .question-box ul li strong {font-size: 20px; margin-bottom: 25px; display: block;color: #007bff;}
#skin-mbti .question-box ul li label{ display: block;background-color:transparent; width: auto; height: 36px;text-align: left; line-height: 38px; padding-left: 20px;}
#skin-mbti .question-box ul li input {position: absolute; }
#skin-mbti .question-box ul li input:checked + label{ background-color: #007bff; color: #fff; font-weight: 600;}
#skin-mbti .question-box .submit {border: 1px solid #696969; display: block; width: 100%; height: 33px; margin: 0 auto;}
.section_name_A__list input:radio:checked {background-color: yellow;}
.done {height: 0px; overflow: hidden;}
.transparent {opacity: 1 !important;;}
</style>  


<br>
<br>
<hr>
<ul id="stage-state"></ul>
<div id="skin-mbti"></div>

<br>
<br>
<button class="next">next</button>
<button class="del">delcookie</button>
<button class="get">getcookie</button>


  <script src="./data.js"></script>
  <script>
  //값이있는지 확인 // 쿠키와비교 // init 함수 만들기 
  //검사 완료 쿠키 - 검사도중 쿠키 날리고 결과 쿠키만 일정시간남김 - 메인 갈때 쿠키있으면 (결과확인, 다시 테스트 링크)
  //검사도중 쿠키 -  체크박스 클릭때마다 쿠키 덮어쓰면서 문항저장함 // 기간은 1-2시간정도 남기기 (진행중인 검사 , 다시 테스트 링크)
  // 결과 페이지 - 마지막 값을 get 데이터로 넘겨서 파라미터로 받은값에따라서 결과 내용 출력하기 
  // 링크도 동일하게 링크를 객체에 담던지 , 링크경로를 포멧팅하던지 하기
  //각 섹션에 점수 기준 객체 만들기;
  //쿠키로 보내고 ; 렌더링할때 쿠키 확인
  console.log(QUESTION_DATA)


  /*---------------------------------------쿠키----------------------------------------------*/
  //쿠키 생성
  const setCookie = (name,value,m) => {
    var date = new Date();
    date.setTime(date.getTime() + m * 60 * 1000);
    document.cookie = name + "=" + encodeURI(value) +  ';expires=' + date.toUTCString() + ';path=/';
  }
  //쿠키 삭제
  const delCookie = (Name) => {
    var expireDate = new Date();
    expireDate.setDate(expireDate.getDate() - 1);
    document.cookie = Name + "= " + "; expires=" + expireDate.toGMTString() + "; path=/";
  }
  //쿠키 가져오기
  const getCookie = (name) => {
    var x, y;
    var val = document.cookie.split(';');
    for (var i = 0; i < val.length; i++) {
        x = val[i].substr(0, val[i].indexOf('='));
        y = val[i].substr(val[i].indexOf('=') + 1);
        x = x.replace(/^\s+|\s+$/g, '');
        if (x == name) {
            return unescape(y);
        }
    }
  }

  /*-------------------------------------요소 생성----------------------------------------------*/

//진행 스테이지 표시창 생성
  const createStageBar = (stageBox,data) => {
    var html = "";

    data.forEach(({section_id , section_name}) => {
      html += `<li data-id=${section_id} >${section_name}</li>`
    })
    stageBox.insertAdjacentHTML('beforeend',html);

    return {
      update : (id = "OD") => {
        console.log(id)
        var currntStageIdx = data.findIndex(({section_id})=> section_id === id);
        var stages = [...stageBox.children];

        stages.forEach(li => li.style.background = "#fff")
        stages.forEach((li,i) => {
          if (i <= currntStageIdx - 1) {
            li.style.background = "#007bff";
          }
        })
      }
    }
  }
  var stageBar = createStageBar(document.querySelector('#stage-state'),QUESTION_DATA)

  //폼 요소 생성 
  const createForm = ({section_id, section_name, data}, wrap) => {
    var html = "";
    html += `<section id=${section_id + "section"}>`
    html += `<h2 class="stage-title" data-id=${section_id}>${section_name}</h2>`;
    html += `<div class="question-box" class="section-box">`;

    data.forEach(({id, question, option},i) => {

    
        html += `<ul class=${"ul-"+section_id+id}>`;
        html += `<li><strong>${id+"."+question}</strong></li>`;

        option.forEach(({no, option_text}) => {
          html += "<li>";
          html += `<input id=${section_id+id+no} type="radio" value="${no}" name="${section_id+id}" hidden/>`;
          html += `<label for=${section_id+id+no}>${option_text}</label>`;
          html += "</li>";
        })
        html += "</ul>";
    })
    html += `<button class='submit' data-id=${section_id}>NEXT</button>`
    html += "</div></section>";
    wrap.insertAdjacentHTML('beforeend',html);

    return document.getElementById(section_id + "section");
  }
 

/*---------------------------------------기능함수-----------------------------------------*/

//쿠키 데이터 담아서 보내기 
  const sendParamsToCookie = () => {
    var isHistory = getCookie(COOKIE_OPTION.history.name) 
    var params = isHistory ?  new URLSearchParams(isHistory) : new URLSearchParams() 

    return (key , value) => {
      if(!key || !value) return

      params.set(key,value)
      params.sort();
      setCookie(COOKIE_OPTION.history.name ,params.toString(), COOKIE_OPTION.history.time)
    }
  }
  let sendParams = sendParamsToCookie()
  //상품 전체 체크 확인 
  const checkPass = ({section_id ,data}) => {
    var mapRadio = data.map(obj => [...document.getElementsByName(section_id + obj.id)])
    var checkSelect = mapRadio.every(radioArr => radioArr.find(radio => radio.checked === true));

    return checkSelect
  }
  //진행중 쿠키에 기록된 내용 체크 //마지막 ul 태그 반환
  const recoveryChecked = (cookieData) => {
    var params = new URLSearchParams(cookieData);

      var lastTarget
      for (const [key, value] of params.entries()) {
        var inputs = [...document.getElementsByName(key)]
        var checkTarget = inputs.find(input => input.value === value)
        checkTarget.checked = true
        lastTarget = checkTarget;
      }

      return lastTarget.parentElement.parentElement
  }
  //점수 계산
  const calcScore = ({section_id ,data}) =>{
  var mapRadio = data.map(obj => [...document.getElementsByName(section_id + obj.id)])
  var score = 0;

  var filterRadio = mapRadio.flat(1).filter(radio => radio.checked === true)
  score += filterRadio.reduce((acc,curr) => acc + QUESTION_SCORE[curr.value],0)
  console.log("타입 :",QUESTION_TYPE[section_id](score),"--","점수 :",score)//result 

  return score
  }
  //요소 맨위로 스크롤
  const scrollIntoSectionTop = (el) => {
    if(!el) return
    var stickyH = document.getElementById('stage-state').offsetHeight;
    var targetY = el.offsetTop;
    window.scrollTo(0,targetY - stickyH);
  }
  //요소 중심으로 스크롤
  const scrollIntoSectionMiddle= (el) => {
    if(!el) return
    var stickyH = document.getElementById('stage-state').offsetHeight;
    var targetHalf = el.offsetHeight / 2;
    var targetY = el.offsetTop;
    var screenHalf = window.innerHeight / 2;
    window.scrollTo(0,targetY + targetHalf - stickyH - screenHalf);
  }
  //opacity 토글 
  const toggleOpacity = (el) => {
    var uls = [...el.parentElement.children]
    uls.forEach(ul => ul.classList.remove('transparent'))
    el.classList.add('transparent')
  }
  //가장 근접한 체크안된 문항 요소 반환 
  const focusLastEl = (ul) => {
    var uls = [...ul.parentElement.children]
    var lastEl = uls.find((ul,i) => {
      var inputs = [...ul.querySelectorAll('input')]
      return inputs.every(input =>input.checked === false)
    })
    return lastEl
  }

/*DOM-root --------------------------------------------------------------------------------*/
  const mbtiWrap = document.getElementById('skin-mbti');
/*----------------------------------분기처리-------------------------------------------------*/

//load 될때 상태(저장정보)따른 분기 
const loadBranch = _ => {
  var getHistory = getCookie(COOKIE_OPTION.history.name);

  if (getHistory) { //저장되어 있는 정보 있을때
    var score = new URLSearchParams(getHistory);

    for (const [key] of score.entries()) {
      QUESTION_PROGRESS_STATE[key.replace(/[0-9]/ig,"")] = true;
    }

    var lastSection;
    QUESTION_DATA.forEach((data , i) => {
      if(QUESTION_PROGRESS_STATE[data.section_id]){
        var form = createForm(data,mbtiWrap);
        form.classList.add("done")
        lastSection = form
        data.section_id + "section"
        stageBar.update(data.section_id)
      }
    })
    
    lastSection.classList.remove("done")
    var lastEl = recoveryChecked(getHistory)
    scrollIntoSectionMiddle(lastEl.nextElementSibling)
    toggleOpacity(lastEl.nextElementSibling)
    console.log("load save")

  } //history
  else { //저장 정보 X
    var newform = createForm(QUESTION_DATA[0],mbtiWrap)
    toggleOpacity(newform.querySelector('.question-box').firstElementChild)
    console.log("new")
  }
}
loadBranch()


//title 버튼 분기
const btnBranch = (e) => {
    if (e.target.className !== "stage-title")  return

    var boxes = document.querySelectorAll('.question-box')

    if (boxes.length > 1) {
      boxes.forEach(box => {
        if (box.parentElement.id.includes(e.target.dataset.id + "section")) {
          stageBar.update(e.target.dataset.id)
          box.classList.remove('done')
        }
        else{
          box.classList.add('done')
        }
      })
    }
}


//check Box 버튼 콜백 함수
const checkBranch = (e) => {
  if(e.target.type !== "radio") return 

  const ul = document.querySelector('.ul-' + e.target.name)
  sendParams(e.target.name,e.target.value)
  
  if (ul.nextElementSibling.tagName !== "button") {
    var noneCheckedEl = focusLastEl(ul)
    scrollIntoSectionMiddle(noneCheckedEl);
    toggleOpacity(noneCheckedEl)
  }
}

//NEXT 버튼 분기
const submitBranch = (e) => {
  if(e.target.tagName !== "BUTTON") return
  var submitId = e.target.dataset.id;
  var finish = false;
  QUESTION_DATA.forEach((data,i,arr) => {
    if(submitId === data.section_id && checkPass(data)){
      //전부 체크
      var section = document.querySelector("#" + data.section_id + "section .question-box" )
      var nextSection = document.querySelector( "#" + arr[i + 1]?.section_id + "section .question-box")
      section.classList.add("done")
      
      if (i < arr.length - 1 && !nextSection) { // 다음 스테이지가 활성화 되지 않을때 
        var newSection = createForm(arr[i + 1],mbtiWrap);
        var firstQuestionBox  = newSection.querySelector('.question-box').firstElementChild

        scrollIntoSectionTop(newSection)
        toggleOpacity(firstQuestionBox)
        stageBar.update(arr[i + 1].section_id)
      } 
      else if(nextSection){ // 다음 스테이지가 활성화 되어있음 
          nextSection.classList.remove('done')
          stageBar.update(arr[i + 1].section_id)
      }
      else if (i === arr.length - 1){ //설문 끝
        finish = true 
        return
      }

    } 
    else if(submitId === data.section_id && !checkPass(data)){
      console.log("error")
    }

  })

  if(finish){ //점수랑 등급 쿼리 url 붙여서 보내고, 타입 쿠키로 저장
      var type = "";
      var score = new URLSearchParams();
      QUESTION_DATA.forEach(data =>{
        type += QUESTION_TYPE[data.section_id](calcScore(data)) //임시
        score.set(data.section_id,calcScore(data));
      })
        
        delCookie(COOKIE_OPTION.history.name)
        setCookie(COOKIE_OPTION.result.name, type, COOKIE_OPTION.result.time)
        location.href = `/result.html?type=${type}&score=${score.toString()}`;
  }
} //submitBranch


/*--------------------------------------이벤트-------------------------------------------------*/
  mbtiWrap.addEventListener('change',checkBranch)
  mbtiWrap.addEventListener('click', e => {
    btnBranch(e)
    submitBranch(e)
  })
  //test 
document.querySelector('.del').addEventListener('click',()=>{delCookie('skintype')})
document.querySelector('.get').addEventListener('click',()=>{console.log(getCookie('skintype'))})

/*------------------------observer-------------------------------*/

const ioFn = (entries) => {
  entries.forEach((entry) => {
    console.log(entry)
    if (entry.intersectionRatio > 0) {
      entry.target.classList.add("active");
    }
    else {
      entry.target.classList.remove("active");
    }
  });
}

const ioOpt =  {
  root: null,
  rootMargin: "0px",
}

const questionBoxes = mbtiWrap.querySelectorAll('.question-box')
const io = new IntersectionObserver(ioFn,ioOpt)
questionBoxes.forEach(boxes => {
  [...boxes.children].forEach(box => {
    if (box.tagName === "UL") {
    io.observe(box)
    }
  })
})
  </script>
</body>
</html>