<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
<style>
.section_name_A__list input:radio:checked {background-color: yellow;}
</style>  


<br>
<br>
<hr>
<ul id="stage-state"></ul>
<div id="skin-mbti"></div>
<button class="next">next</button>
<button class="del">delcookie</button>
<button class="get">getcookie</button>





  <script src="./data.js"></script>
  <script>
  //값이있는지 확인 // 쿠키와비교 // init 함수 만들기 
  //검사 완료 쿠키 - 검사도중 쿠키 날리고 결과 쿠키만 일정시간남김 - 메인 갈때 쿠키있으면 (결과확인, 다시 테스트 링크)
  //검사도중 쿠키 -  체크박스 클릭때마다 쿠키 덮어쓰면서 문항저장함 // 기간은 1-2시간정도 남기기 (진행중인 검사 , 다시 테스트 링크)
  // 결과 페이지 - 마지막 값을 get 데이터로 넘겨서 파라미터로 받은값에따라서 결과 내용 출력하기 
  // 링크도 동일하게 링크를 객체에 담던지 , 링크경로를 포멧팅하던지 하기
  //각 섹션에 점수 기준 객체 만들기;
  //쿠키로 보내고 ; 렌더링할때 쿠키 확인
  console.log(QUESTION_DATA)

  /*---------------------------------------쿠키----------------------------------------------*/
  //쿠키 생성
  const setCookie = (name,value,m) => {
    var date = new Date();
    date.setTime(date.getTime() + m * 60 * 1000);
    document.cookie = name + "=" + encodeURI(value) +  ';expires=' + date.toUTCString() + ';path=/';
  }

  //쿠키 삭제
  const delCookie = (Name) => {
    var expireDate = new Date();
    expireDate.setDate(expireDate.getDate() - 1);
    document.cookie = Name + "= " + "; expires=" + expireDate.toGMTString() + "; path=/";
  }

  //쿠키 가져오기
  const getCookie = (name) => {
    var x, y;
    var val = document.cookie.split(';');
    for (var i = 0; i < val.length; i++) {
        x = val[i].substr(0, val[i].indexOf('='));
        y = val[i].substr(val[i].indexOf('=') + 1);
        x = x.replace(/^\s+|\s+$/g, '');
        if (x == name) {
            return unescape(y);
        }
    }
  }

  /*-------------------------------------요소 생성----------------------------------------------*/

//진행 스테이지 표시창 생성
  const createStageBar = (stageBox,data) => {
    var html = "";

    data.forEach(({section_id , section_name}) => {
      html += `<li data-id=${section_id} >${section_name}</li>`
    })
    stageBox.insertAdjacentHTML('beforeend',html);

    return {
      update : (id = "OD") => {
        var currntStageIdx = data.findIndex(({section_id})=> section_id === id)
        var stages = [...stageBox.children]

        stages.forEach((li,i) => {
          if (i <= currntStageIdx) {
            li.style.background = "red"
          }
        })
      }
    }
  }
  var stageBar = createStageBar(document.querySelector('#stage-state'),QUESTION_DATA)

  //폼 요소 생성 
  const createForm = ({section_id, section_name, data}, wrap) => {
    var html = "";
    html += `<h2>${section_name}</h2>`;
    html += `<div id=${section_name}>`;

    data.forEach(({id, question, option}) => {
        html += `<ul class=${section_name + "__" + "list"}>`;
        html += `<li><strong>${id+"."+question}</strong></li>`;

        option.forEach(({no, option_text}) => {
          html += "<li>";
          html += `<label>${option_text}`;
          html += `<input type="radio" value="${no}" name="${section_id+id}"/>`;
          html += "</label>";
          html += "</li>";
        })
        html += "</ul>";
    })
    html += `<button class='submit' data-id=${section_id}>submit</button>`
    html += "</div>";
    wrap.insertAdjacentHTML('beforeend',html);
    return document.getElementById(section_name);
  }
  const mbtiWrap = document.getElementById('skin-mbti');
  const form = createForm(QUESTION_DATA[0],mbtiWrap)



 /*-----------------------------------------------------------------------------------*/

//쿠키 데이터 담아서 보내기 
  const sendParamsToCookie = () => {
    var params = new URLSearchParams();
    return (key , value) => {
      if(!key || !value) return 
      params.set(key,value)
      params.sort();
      setCookie("skintype",params.toString(),1)
    }
  }
  let sendParams = sendParamsToCookie()


  //상품 전체 체크 확인 
  const checkPass = ({section_id ,data}) => {
    var mapRadio = data.map(obj => [...document.getElementsByName(section_id + obj.id)])
    var checkSelect = mapRadio.every(radioArr => radioArr.find(radio => radio.checked === true));
    return checkSelect
  }


  //점수 계산
  const calcScore = ({section_id ,data}) =>{
  var mapRadio = data.map(obj => [...document.getElementsByName(section_id + obj.id)])
  var score = 0;

  var filterRadio = mapRadio.flat(1).filter(radio => radio.checked === true)
  score += filterRadio.reduce((acc,curr) => acc + QUESTION_SCORE[curr.value],0)
  console.log("타입 :",QUESTION_TYPE[section_id](score),"--","점수 :",score)//result 

  return score
}

//core fn
var resultT = ""
const branchStage = (e) => {
  if(e.target.tagName !== "BUTTON") return
  var submitId = e.target.dataset.id;

  QUESTION_DATA.forEach((data,i,arr) => {
    if(submitId === data.section_id && checkPass(data)){
      
      resultT += QUESTION_TYPE[data.section_id](calcScore(data)) //임시
      QUESTION_PROGRESS_STATE.reset();
      QUESTION_PROGRESS_STATE[submitId] = true 
      stageBar.update(submitId)



      
      if (i < arr.length - 1) {
        createForm(arr[i+1],mbtiWrap);
      }

      if (i === arr.length - 1) {
        console.log("끝");

        delCookie("skintype")
        setCookie("resulttype",resultT,5)
        //점수랑 등급 쿼리스트링에 붙여서 보내고, 쿠키로도 저장하기 
        location.href = `/?result=${resultT}`;
      }

      console.log(QUESTION_PROGRESS_STATE)
    } 
    else if(submitId === data.section_id && !checkPass(data)){

      console.log("error")

    }
  })
}


//이벤트 헨들러 
  mbtiWrap.addEventListener('change', e => {
      if(e.target.type !== "radio") return 
      sendParams(e.target.name,e.target.value)  
  })

  mbtiWrap.addEventListener('click',branchStage)

  //test 
document.querySelector('.del').addEventListener('click',()=>{delCookie('skintype')})
document.querySelector('.get').addEventListener('click',()=>{console.log(getCookie('skintype'))})



  
  /*
  if (id === 'OD' && checkAllselect(QUESTION_DATA[0])) {
    calcScore(QUESTION_DATA[0],'')
    createForm(QUESTION_DATA[1],mbtiWrap) 
  }

  if (id === 'SR'  && checkAllselect(QUESTION_DATA[1])) {
    calcScore(QUESTION_DATA[1],'') 
    createForm(QUESTION_DATA[2],mbtiWrap) 
  }

  if (id === 'PN'   && checkAllselect(QUESTION_DATA[2])) {
    calcScore(QUESTION_DATA[2],'')
    createForm(QUESTION_DATA[3],mbtiWrap)
  }

  if (id === 'WT'   && checkAllselect(QUESTION_DATA[3])) {
    calcScore(QUESTION_DATA[3],'')
  }
  */

  /*
      params.forEach((v,k)=>{
        checked.push({[k]:v})
      })
      console.log(params.toString())
      console.log(checked)
      */

      //!params.has(key) ? params.append(key,value) : 
         //const checkSameIdx = saveData.findIndex(data => data.hasOwnProperty(key))
        //checkSameIdx === -1
        //saveData.push({[key] : value})
        //saveData[checkSameIdx][key] = value;
        //const mapQuery = saveData.map(save =>Object.entries(save).join('=').replace(/\,/ig,"=")).join('&');

        
  </script>
</body>
</html>